/*===================================================================
CFontObjectsクラス
フォントのオブジェクト管理クラスです。
===================================================================*/

#include <math.h>
#include "Footy2.h"
#include "FontObjects.h"
#pragma warning (disable : 4996)

const int CFontObjects::m_nCharSets[FFM_NUM_FONTS] = 
{
	ANSI_CHARSET,
	BALTIC_CHARSET,
	CHINESEBIG5_CHARSET,
	EASTEUROPE_CHARSET,
	GB2312_CHARSET,
	GREEK_CHARSET,
	HANGUL_CHARSET,
	RUSSIAN_CHARSET,
	SHIFTJIS_CHARSET,
	TURKISH_CHARSET,
	VIETNAMESE_CHARSET,
	ARABIC_CHARSET,
	HEBREW_CHARSET,
	THAI_CHARSET
};

/*-------------------------------------------------------------------------
CFontObjects::GetFontHandle
コンストラクタです。
-------------------------------------------------------------------------*/
CFontObjects::CFontObjects(){
	/*全てNULL化*/
	for (int i=0;i<FFM_NUM_FONTS;i++)
		m_hFont[i] = NULL;
	m_hRulerFont = NULL;
	m_fnWeight = FW_BOLD;
	m_nFontHeight = 0;
	m_nFontWidth = 0;
	m_nRulerHeight = 0;
	/*デフォルトフォント名を入れておく*/
	m_strFace[FFM_ANSI_CHARSET]			= L"Courier New";
	m_strFace[FFM_BALTIC_CHARSET]		= L"Courier New";
	m_strFace[FFM_BIG5_CHARSET]			= L"MingLiU";
	m_strFace[FFM_EASTEUROPE_CHARSET]	= L"Courier New";
	m_strFace[FFM_GB2312_CHARSET]		= L"SimSun";
	m_strFace[FFM_GREEK_CHARSET]		= L"Courier New";
	m_strFace[FFM_HANGUL_CHARSET]		= L"GulimChe";
	m_strFace[FFM_RUSSIAN_CHARSET]		= L"Courier New";
	m_strFace[FFM_SHIFTJIS_CHARSET]		= L"MS Gothic";
	m_strFace[FFM_TURKISH_CHARSET]		= L"Courier New";
	m_strFace[FFM_VIETNAMESE_CHARSET]	= L"Courier New";
	m_strFace[FFM_ARABIC_CHARSET]		= L"GulimChe";
	m_strFace[FFM_HEBREW_CHARSET]		= L"Courier New";
	m_strFace[FFM_THAI_CHARSET]			= L"Tahoma";
	m_nFontPoint	=	FONTNORMAL_DEFAULT;
}

/*-------------------------------------------------------------------------
CFontObjects::~CFontObjects
デストラクタです。
-------------------------------------------------------------------------*/
CFontObjects::~CFontObjects(){
	for (int i=0;i<FFM_NUM_FONTS;i++){
		if (m_hFont[i]){
			DeleteObject(m_hFont[i]);
			m_hFont[i] = NULL;
		}
	}
}

/*-------------------------------------------------------------------------
CFontObjects::CreateFontObject
一つ分のフォントを作り直す処理
-------------------------------------------------------------------------*/
bool CFontObjects::CreateFontObject(int nType,HDC hDC){
	m_hFont[nType] = GetFontHandle(m_strFace[nType].c_str(),
			HeightFromPoint(hDC,m_nFontPoint),
			false,m_nCharSets[nType]);
	if (!m_hFont[nType])return false;
	return true;
}

/*-------------------------------------------------------------------------
CFontObjects::RecreateAll
全てのフォントを作り直す処理
-------------------------------------------------------------------------*/
bool CFontObjects::RecreateAll(HDC hDC){
	for (int i=0;i<FFM_NUM_FONTS;i++){
		if (!CreateFontObject(i,hDC))return false;
	}
	SetFontPixels(hDC);
	return true;
}

/*-------------------------------------------------------------------------
CFontObjects::SetFontFace
フォントをセットする処理
-------------------------------------------------------------------------*/
bool CFontObjects::SetFontFace(int nType,const wchar_t *pFontFace,HDC hDC){
	m_strFace[nType] = pFontFace;
	if (!CreateFontObject(nType,hDC))return false;
	SetFontPixels(hDC);
	return true;
}

/*-------------------------------------------------------------------------
CFontObjects::SetFontPixels

-------------------------------------------------------------------------*/
void CFontObjects::SetFontPixels(HDC hDC){
	HFONT hFontOld;					/*フォントハンドル*/
	SIZE wSize;						/*wの大きさ*/
	hFontOld = (HFONT)SelectObject(hDC,GetKanjiFont());
	GetTextExtentPoint32W(hDC,L"abcdefghijklmnopqrstuvwxyz",26,&wSize);
	SelectObject(hDC,hFontOld);
	m_nFontWidth = wSize.cx / 26;
	m_nFontHeight = wSize.cy;
}

/*-------------------------------------------------------------------------
CFontObjects::SetRuler
ルーラー用フォントの作成
-------------------------------------------------------------------------*/
bool CFontObjects::SetRuler(HDC hDC,int nRulerHeight){
	/*宣言*/
	HFONT hTemp;
	/*フォントを作成*/
	hTemp = GetFontHandle(m_strFace[FFM_ANSI_CHARSET].c_str(),nRulerHeight,false,ANSI_CHARSET);
	if (!hTemp)return false;
	m_hRulerFont = hTemp;
	m_nRulerHeight = nRulerHeight;
	return true;
}

/*-------------------------------------------------------------------------
CFontObjects::GetFontHandle
<引数>
szFontName	フォントの名前
nPoint		フォントの大きさ
hDC			デバイスコンテキストハンドル
<解説>
フォントを作成して、それを返します。
-------------------------------------------------------------------------*/
HFONT CFontObjects::GetFontHandle(const wchar_t *szFontName,int nHeight,bool bBold,int nCharSets){
	/*フォントを作成(CreateFontはCEで使えない)*/
	LOGFONTW fontStruct;
	memset(&fontStruct,0,sizeof(LOGFONTW));
	fontStruct.lfHeight = nHeight;
	fontStruct.lfWeight = (bBold ? m_fnWeight : FW_NORMAL);
	fontStruct.lfCharSet = nCharSets;
	fontStruct.lfOutPrecision = OUT_DEFAULT_PRECIS;
	fontStruct.lfClipPrecision = CLIP_DEFAULT_PRECIS;
	fontStruct.lfQuality = DEFAULT_QUALITY;
	fontStruct.lfPitchAndFamily = FF_MODERN | FIXED_PITCH;
	wcsncpy(fontStruct.lfFaceName,szFontName,LF_FACESIZE);
	return CreateFontIndirectW(&fontStruct);
}

/*-------------------------------------------------------------------------
CFontObjects::GetMulDiv
nNumber * nNumerator / nDenominator を四捨五入して返す
-------------------------------------------------------------------------*/
int CFontObjects::GetMulDiv(int nNumber,int nNumerator,int nDenominator){
	long long nTemp = nNumber * nNumerator;
	double fReturn = ((double)nTemp / nDenominator);
	fReturn += 0.5f;
	return (int)floor(fReturn);
}

/*[EOF]*/
